# unknown-codes-investigation

[View on OpenSAFELY](https://jobs.opensafely.org/repo/https%253A%252F%252Fgithub.com%252Fopensafely%252Funknown-codes-investigation)

This repo is for investigating whether any any columns in TPP contain codes that are not present in OpenCodelists.
See https://github.com/opensafely-core/opencodelists/issues/1394.

It uses SQL Runner, and so the automated tests do not pass.

### The SQL

The SQL to count the number of occurrences of each code in each month looks like this:

    WITH events AS (
        SELECT
            CONVERT(VARCHAR(7), ConsultationDate, 23) AS month,
            CTV3Code AS code
        FROM CodedEvent
        WHERE ConsultationDate >= '2015-01-01'
    )

    SELECT month, code, ROUND(COUNT(*), -1) AS num
    FROM events
    GROUP BY month, code
    ORDER BY month, code

There are a couple of unusual SQL constructs to point out:

* `CONVERT(VARCHAR(7), some_date, 23)` converts a date to the format `YYYY-MM`.  `23` indicates ISO8601 format (`YYYY-MM-DD`), and `7` is the length of `YYYY-MM`.
* `ROUND(some_value, -1)` rounds the given value to -1 decimal places, that is, to the nearest 10.

### Codes

The `coding_systems` directory contains .txt files of the codes currently present in OpenCodelists.
These files were generated by running the following in the Django shell:

    >>> from coding_systems import ctv3, icd10, snomedct
    >>> with open("ctv3.txt", "w") as f:
    ...   for c in ctv3.models.TPPConcept.objects.all():
    ...     _ = f.write(c.read_code + "\n")
    ...
    >>> with open("icd10.txt", "w") as f:
    ...   for c in icd10.models.Concept.objects.all():
    ...     _ = f.write(c.code + "\n")
    ...
    >>> with open("snomedct.txt", "w") as f:
    ...   for c in snomedct.models.Concept.objects.all():
    ...     _ = f.write(c.id + "\n")
    ...


# Caution

Results in this repository MUST NOT be considered an accurate or valid representation of the study purpose. These data may reflect an incomplete or incorrect analysis with no further ongoing work.
The repository content has ONLY been made public to support the OpenSAFELY [open science and transparency principles](https://www.opensafely.org/about/#contributing-to-best-practice-around-open-science) and to support the sharing of re-usable code for other subsequent users.
The results have not been peer-reviewed.
No clinical, policy or safety conclusions must be drawn from any of the data here.

# About the OpenSAFELY framework

The OpenSAFELY framework is a Trusted Research Environment (TRE) for electronic
health records research in the NHS, with a focus on public accountability and
research quality.

Read more at [OpenSAFELY.org](https://opensafely.org).

# Licences
As standard, research projects have a MIT license. 
