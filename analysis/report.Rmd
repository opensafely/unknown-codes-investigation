---
title: "Unknown Codes Investigation"
date: "Report last updated: `r lubridate::today()`"
output:
  html_document:
    code_folding: hide
    toc: true
    toc_depth: 3
    toc_float: true
---

```{r, rmd-setup, include=FALSE}

knitr::opts_chunk$set(echo = TRUE, message = FALSE, warning = FALSE)

library(tidyverse)
library(lubridate)
library(scales)
library(here)
library(knitr)
library(DT)
```

# Overview

This report investigates which clinical codes are used in the TPP backend but not available in OpenCodelists.

The current version of the reports looks at the following tables:

- APCS_Der.Spell_Primary_Diagnosis (icd10)
- CodedEvent.CTV3Code (ctv3)
- CodedEvent_SNOMED.ConceptID (snomedct)

# Load and summarise data

- The date range of data presented in this report was limited from 2015-01-01 to **CHECK LAST RUN TIME**

```{r}
# Read data
df_codes <- read_csv(here("output/output.csv")) %>%
  mutate(month = as.Date(paste0(month, "-01"))) %>%
  mutate(code_unknown = factor(case_when(code_unknown ~ "Code unknown",
                                         !code_unknown ~ "Code known")),
         data_source = factor(data_source),
         coding_system = factor(coding_system)) %>%
  filter(month > as_date("2015-01-01") & month < today())
```

## Descriptives

The following table shows the minimum and maximum number (`min_num`, `max_num`) and date (`min_date`, `max_date`) of known and unknown codes.

```{r}
# Count number of known and unknown codes for each coding system
df_codes %>%
  group_by(data_source, coding_system, code_unknown) %>%
  summarise(min_num = comma(min(num)),
            max_num = comma(max(num)),
            min_date = min(month),
            max_date = max(month)) %>%
  datatable()
```

## Unique codes

This table shows the count of unique known and unknown codes in TPP each table.

```{r}

df_codes %>%
  group_by(data_source, coding_system, code_unknown) %>%
  select(-c(month, num)) %>%
  distinct() %>%
  summarise(n_unique_unknown_codes = comma(n())) %>%
  datatable()

```

# Visualising monthly changes 

## Sum of known and unknown codes

```{r fig.width=9, fig.height=6}

# First, calculate sum of number of known/unknown codes used in TPP backend by month
df_codes_sum <- df_codes %>%
  group_by(data_source, coding_system, code_unknown, month) %>%
  mutate(code_sum_num = sum(num, na.rm = TRUE)) %>%
  ungroup() %>%
  select(-num, -code) %>%
  distinct()

# Create plot
df_codes_sum %>%
    ggplot(aes(
      x = month,
      y = code_sum_num,
      colour = coding_system
    )) +
    geom_line(
      size = .7,
      alpha = 0.3
    ) +
    geom_point(
      size = 1,
      alpha = 0.9
    ) +
    scale_x_date(
      date_breaks = "6 months",
      labels = label_date_short()
    ) +
    theme(text = ggplot2::element_text(size = 10)) +
    facet_wrap(~code_unknown, scales = "free_y", ncol = 1) +
    scale_y_continuous(labels = comma)

```


# Sum of distinct unknown codes 

The following table presents the sum (`code_sum`) of each unknown code (`code`) used in TPP between 2015-01-01 to `r lubridate::today()`.
Note that codes were removed from this analysis if there were less than 10 occurences in a given month.

```{r, include=FALSE}
# Extract list of unique tables
list_data_sources <- unique(df_codes$data_source)
# Create object with R chunks contraining table from template file
tables <- lapply(list_data_sources, function(table) knit_expand(file = here("analysis/table_template.Rmd")))
```

<!-- List all R chunks for tables here  -->
`r knit(text = unlist(tables))`
